<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wizz Air "All You Can Fly" - Flight Availability Statistics</title>
    <script src="https://cdn.plot.ly/plotly-3.1.2.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #a71c49;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .chart-container {
            margin: 40px 0;
            min-height: 400px;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #a71c49;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #a71c49;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Wizz Air "All You Can Fly"</h1>
        <p class="subtitle">Flight Availability Statistics Dashboard</p>
        
        <div class="stats" id="summary-stats">
            <div class="stat-card">
                <div class="stat-number" id="total-files">-</div>
                <div class="stat-label">Days Analyzed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-daily-flights">-</div>
                <div class="stat-label">Average Daily Flights</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="date-range">-</div>
                <div class="stat-label">Date Range</div>
            </div>
        </div>

        <div class="chart-container">
            <div id="loading" class="loading">Loading flight data... This may take a moment.</div>
            <div id="weekday-chart" style="display: none;"></div>
            <div id="error-message" class="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        // GitHub repository details
        const GITHUB_USER = 'markvincevarga';
        const GITHUB_REPO = 'wizzair-aycf-availability';
        const DATA_PATH = 'data';
        
        // Cache configuration
        const CACHE_KEY = 'wizz_flight_data_cache';
        const CACHE_VERSION = '1.0';
        
        // Function to get cached data
        function getCachedData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) return null;
                
                const data = JSON.parse(cached);
                if (data.version !== CACHE_VERSION) {
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }
                
                return data;
            } catch (error) {
                localStorage.removeItem(CACHE_KEY);
                return null;
            }
        }
        
        // Function to save data to cache
        function setCachedData(processedFiles, weekdayRawData, weekdayStats) {
            try {
                const cacheData = {
                    version: CACHE_VERSION,
                    processedFiles: processedFiles,
                    weekdayRawData: weekdayRawData,
                    weekdayStats: weekdayStats,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
            } catch (error) {
                console.warn('Error saving to cache:', error);
            }
        }
        
        // Function to get list of CSV files from GitHub API
        async function getCSVFileList() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${DATA_PATH}`);
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                const files = await response.json();
                return files
                    .filter(file => file.name.endsWith('.csv'))
                    .map(file => file.name)
                    .sort();
            } catch (error) {
                console.error('Error fetching file list:', error);
                throw error;
            }
        }
        
        // Function to fetch and parse a single CSV file
        async function fetchCSVData(filename) {
            const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/refs/heads/main/${DATA_PATH}/${filename}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                return parseCSV(text);
            } catch (error) {
                console.warn(`Failed to fetch ${filename}:`, error);
                return null;
            }
        }
        
        // Function to parse CSV text
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index].trim();
                    });
                    data.push(row);
                }
            }
            
            return data;
        }
        
        // Function to extract date from filename
        function getDateFromFilename(filename) {
            const match = filename.match(/^(\d{4}-\d{2}-\d{2})/);
            return match ? new Date(match[1]) : null;
        }
        
        // Function to get weekday name
        function getWeekdayName(date) {
            const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return weekdays[date.getDay()];
        }
        
        // Function to analyze flight data and create weekday statistics
        async function analyzeFlightData() {
            try {
                // Get cached data if available
                const cachedData = getCachedData();
                let processedFiles = cachedData ? new Set(cachedData.processedFiles) : new Set();
                let weekdayData = cachedData && cachedData.weekdayRawData ? cachedData.weekdayRawData : {
                    'Monday': { flights: [], count: 0 },
                    'Tuesday': { flights: [], count: 0 },
                    'Wednesday': { flights: [], count: 0 },
                    'Thursday': { flights: [], count: 0 },
                    'Friday': { flights: [], count: 0 },
                    'Saturday': { flights: [], count: 0 },
                    'Sunday': { flights: [], count: 0 }
                };
                
                // Ensure weekdayData has the correct structure
                Object.keys(weekdayData).forEach(day => {
                    if (!weekdayData[day].flights) {
                        weekdayData[day].flights = [];
                    }
                    if (typeof weekdayData[day].count !== 'number') {
                        weekdayData[day].count = 0;
                    }
                });
                
                // Get list of all available CSV files
                const allFiles = await getCSVFileList();
                console.log(`Found ${allFiles.length} total CSV files`);
                
                // Find files we haven't processed yet
                const newFiles = allFiles.filter(filename => !processedFiles.has(filename));
                console.log(`Found ${newFiles.length} new files to process`);
                
                if (newFiles.length === 0) {
                    console.log('No new files to process, using cached data');
                    // Still need to calculate stats from existing data
                    return calculateWeekdayStats(weekdayData, Array.from(processedFiles));
                }
                
                // Process new files
                let totalProcessed = processedFiles.size;
                for (const filename of newFiles) {
                    const data = await fetchCSVData(filename);
                    if (data && data.length > 0) {
                        const date = getDateFromFilename(filename);
                        if (date) {
                            const weekday = getWeekdayName(date);
                            const flightCount = data.length;
                            
                            weekdayData[weekday].flights.push(flightCount);
                            weekdayData[weekday].count++;
                            processedFiles.add(filename);
                            totalProcessed++;
                            
                            // Update progress
                            document.getElementById('loading').textContent = 
                                `Processing new data... ${totalProcessed} files processed`;
                        }
                    }
                }
                
                // Calculate and cache the updated data
                const weekdayStats = calculateWeekdayStats(weekdayData, Array.from(processedFiles));
                setCachedData(Array.from(processedFiles), weekdayData, weekdayStats);
                
                return weekdayStats;
                
            } catch (error) {
                console.error('Error analyzing flight data:', error);
                throw error;
            }
        }
        
        // Function to calculate statistics from raw weekday data
        function calculateWeekdayStats(weekdayData, processedFiles) {
            // Calculate final statistics
            const weekdayStats = {};
            Object.keys(weekdayData).forEach(day => {
                const flights = weekdayData[day].flights;
                if (flights.length > 0) {
                    const mean = flights.reduce((sum, count) => sum + count, 0) / flights.length;
                    const variance = flights.reduce((sum, count) => sum + Math.pow(count - mean, 2), 0) / flights.length;
                    const stdDev = Math.sqrt(variance);
                    
                    weekdayStats[day] = {
                        average: Math.round(mean),
                        stdDev: stdDev,
                        count: flights.length
                    };
                } else {
                    weekdayStats[day] = {
                        average: 0,
                        stdDev: 0,
                        count: 0
                    };
                }
            });
            
            // Update summary statistics
            const totalDays = Object.values(weekdayStats).reduce((sum, day) => sum + day.count, 0);
            const totalFlights = Object.values(weekdayStats).reduce((sum, day) => sum + (day.average * day.count), 0);
            const avgDaily = totalDays > 0 ? Math.round(totalFlights / totalDays) : 0;
            
            // Get date range from processed files
            const dates = processedFiles
                .map(filename => getDateFromFilename(filename))
                .filter(date => date !== null)
                .sort((a, b) => a - b);
            
            const dateRange = dates.length > 0 
                ? `${dates[0].toLocaleDateString()} - ${dates[dates.length - 1].toLocaleDateString()}`
                : 'N/A';
            
            document.getElementById('total-files').textContent = totalDays;
            document.getElementById('avg-daily-flights').textContent = avgDaily;
            document.getElementById('date-range').textContent = dateRange;
            
            return weekdayStats;
        }
        
        // Function to create the weekday chart
        function createWeekdayChart(weekdayStats) {
            const orderedDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const values = orderedDays.map(day => weekdayStats[day].average);
            const errorBars = orderedDays.map(day => weekdayStats[day].stdDev);
            
            const data = [{
                x: orderedDays,
                y: values,
                type: 'bar',
                marker: {
                    color: '#a71c49',
                    opacity: 0.8
                },
                error_y: {
                    type: 'data',
                    array: errorBars,
                    visible: true,
                    color: 'rgba(51, 51, 51, 0.5)',
                    thickness: 2,
                    width: 4
                },
                text: values,
                textposition: 'auto',
                textfont: { color: 'white' },
            }];
            
            const layout = {
                title: {
                    text: 'Average Number of Available Flights by Weekday',
                    font: { size: 18 }
                },
                xaxis: {
                    title: 'Day of Week'
                },
                yaxis: {
                    title: 'Average Number of Flights'
                },
                margin: { t: 60, b: 50, l: 60, r: 20 },
                font: { family: 'Arial, sans-serif' }
            };
            
            const config = {
                responsive: true,
                displayModeBar: false
            };
            
            Plotly.newPlot('weekday-chart', data, layout, config);
        }
        
        // Function to show error message
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').textContent = `Error: ${message}`;
        }
        
        // Main function to load and display data
        async function loadDashboard() {
            try {
                // Check if we have cached data to show immediately
                const cachedData = getCachedData();
                if (cachedData && cachedData.weekdayStats) {
                    console.log('Loading cached data while checking for updates...');
                    
                    // Show cached data immediately
                    updateSummaryStats(cachedData.weekdayStats);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('weekday-chart').style.display = 'block';
                    createWeekdayChart(cachedData.weekdayStats);
                    
                    // Show loading indicator for background update
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('loading').textContent = 'Checking for new data...';
                }
                
                // Always check for and process any new data
                const weekdayStats = await analyzeFlightData();
                
                // Update display with fresh data
                updateSummaryStats(weekdayStats);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('weekday-chart').style.display = 'block';
                createWeekdayChart(weekdayStats);
                
            } catch (error) {
                console.error('Dashboard loading error:', error);
                showError(error.message || 'Failed to load flight data. Please try again later.');
            }
        }
        
        // Function to update summary statistics
        function updateSummaryStats(weekdayStats) {
            const totalDays = Object.values(weekdayStats).reduce((sum, day) => sum + day.count, 0);
            const totalFlights = Object.values(weekdayStats).reduce((sum, day) => sum + (day.average * day.count), 0);
            const avgDaily = totalDays > 0 ? Math.round(totalFlights / totalDays) : 0;
            
            // This will be updated by analyzeFlightData with actual date range
            if (document.getElementById('total-files').textContent === '-') {
                document.getElementById('total-files').textContent = totalDays;
                document.getElementById('avg-daily-flights').textContent = avgDaily;
                document.getElementById('date-range').textContent = 'Loading...';
            }
        }
        
        // Load dashboard when page loads
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>