<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wizz Air "All You Can Fly" - Flight Availability Statistics</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #a71c49;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .chart-container {
            margin: 40px 0;
            min-height: 400px;
            width: 100%;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #a71c49;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #a71c49;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .last-updated {
            text-align: center;
            color: #999;
            font-size: 0.9em;
            margin-top: 20px;
        }
        .chart-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        .bar-chart rect {
            fill: #a71c49;
            opacity: 0.8;
        }
        .bar-chart rect:hover {
            opacity: 1;
            cursor: pointer;
        }
        .bar-chart .axis-label {
            font-size: 12px;
            fill: #666;
        }
        .bar-chart .bar-label {
            font-size: 11px;
            fill: white;
            font-weight: bold;
        }
        .error-bar {
            stroke: #333;
            stroke-width: 1.5;
        }
        .route-line {
            stroke: rgba(167, 28, 73, 0.1);
            stroke-width: 1.5;
            fill: none;
            transition: stroke 0.3s ease, stroke-opacity 0.3s ease, stroke-width 0.3s ease;
        }
        .city-circle {
            fill: #a71c49;
            stroke: white;
            stroke-width: 1;
            transition: fill 0.3s ease, stroke-width 0.3s ease, stroke-opacity 0.3s ease;
        }
        .city-circle:hover {
            stroke-width: 2;
            cursor: pointer;
        }

        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .axis {
            stroke: #666;
        }
        .axis text {
            fill: #666;
            font-size: 12px;
        }
        .grid-line {
            stroke: #e0e0e0;
            stroke-dasharray: 2,2;
        }
        .map-background {
            fill: #e8f4f8;
            stroke: #ccc;
            stroke-width: 1;
        }
        .country {
            fill: #f0f0f0;
            stroke: #ddd;
            stroke-width: 0.5;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }
        .zoom-button {
            background: rgba(167, 28, 73, 0.9);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }
        .zoom-button:hover {
            background: rgba(138, 23, 57, 0.95);
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Wizz Air "All You Can Fly"</h1>
        <p class="subtitle">Flight Availability Statistics Dashboard</p>
        
        <div class="stats" id="summary-stats">
            <div class="stat-card">
                <div class="stat-number" id="total-files">-</div>
                <div class="stat-label">Days Analyzed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-daily-flights">-</div>
                <div class="stat-label">Average Daily Flights</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="date-range">-</div>
                <div class="stat-label">Date Range</div>
            </div>
        </div>

        <div class="chart-container">
            <div id="loading" class="loading">Loading flight data...</div>
            <div id="weekday-chart" style="display: none;"></div>
            <div id="error-message" class="error" style="display: none;"></div>
        </div>

        <div class="chart-container">
            <div id="route-map" style="display: none; position: relative;"></div>
        </div>
        
        <div class="last-updated" id="last-updated"></div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // City coordinates mapping (major Wizz Air destinations)
        const cityCoordinates = {
            'Abu Dhabi': [54.3773, 24.2992],
            'Aberdeen': [-2.0938, 57.1497],
            'Aalesund': [7.1561, 62.4722],
            'Agadir': [-9.5981, 30.3905],
            'Alghero': [8.2903, 40.6321],
            'Alexandria': [29.9187, 31.2001],
            'Alicante': [-0.4814, 38.3452],
            'Almaty': [76.8512, 43.2220],
            'Amman': [35.9239, 31.9539],
            'Ancona': [13.5003, 43.6158],
            'Antalya': [30.7133, 36.8969],
            'Asyut': [31.0118, 27.0465],
            'Athens': [23.7275, 37.9838],
            'Bacau': [26.9335, 46.5671],
            'Baku': [49.8671, 40.4093],
            'Banja Luka': [17.1910, 44.7666],
            'Barcelona': [2.1734, 41.3851],
            'Bari': [16.8719, 41.1171],
            'Basel/Mulhouse': [7.5886, 47.5584],
            'Beirut': [35.4883, 33.8209],
            'Belgrade': [20.4612, 44.7866],
            'Bergen': [5.3221, 60.3913],
            'Berlin': [13.4050, 52.5200],
            'Bilbao': [-2.9349, 43.2627],
            'Billund': [9.1518, 55.7403],
            'Birmingham': [-1.8904, 52.4862],
            'Bishkek': [74.5698, 42.8746],
            'Bologna': [11.3426, 44.4949],
            'Bordeaux': [-0.5792, 44.8378],
            'Brasov': [25.6012, 45.6579],
            'Bratislava': [17.1077, 48.1486],
            'Brindisi': [17.9471, 40.6564],
            'Brussels': [4.3517, 50.8476],
            'Bucharest': [26.1025, 44.4268],
            'Budapest': [19.0402, 47.4979],
            'Burgas': [27.5059, 42.5048],
            'Castellon': [-0.0371, 39.9864],
            'Catania': [15.0871, 37.5079],
            'Chania': [24.1499, 35.5317],
            'Chisinau': [28.8397, 47.0105],
            'Cluj': [23.5719, 46.7712],
            'Cologne': [6.9603, 50.9375],
            'Comiso': [14.6072, 36.9946],
            'Constanta': [28.6348, 44.1598],
            'Copenhagen': [12.5683, 55.6761],
            'Corfu': [19.9156, 39.6243],
            'Craiova': [23.8014, 44.3302],
            'Dalaman': [28.7925, 36.7131],
            'Dammam': [50.1040, 26.4207],
            'Debrecen': [21.6273, 47.5316],
            'Doncaster': [-1.0158, 53.5228],
            'Dortmund': [7.4653, 51.5136],
            'Dubai': [55.2708, 25.2048],
            'Dublin': [-6.2603, 53.3498],
            'Dubrovnik': [18.2692, 42.5614],
            'Dusseldorf': [6.7735, 51.2277],
            'Edinburgh': [-3.1883, 55.9533],
            'Eindhoven': [5.3758, 51.4501],
            'Faro': [-7.9304, 37.0194],
            'Florence': [11.2486, 43.7696],
            'Frankfurt': [8.6821, 50.1109],
            'Friedrichshafen': [9.5115, 47.6720],
            'Fuerteventura': [-14.0147, 28.4527],
            'Gabala': [47.7128, 40.8267],
            'Gdansk': [18.6466, 54.3520],
            'Geneva': [6.1432, 46.2044],
            'Genoa': [8.9463, 44.4056],
            'Girona': [2.7608, 41.9001],
            'Giza': [31.2357, 30.0131],
            'Glasgow': [-4.2518, 55.8642],
            'Gothenburg': [11.9746, 57.7089],
            'Gran Canaria': [-15.4138, 28.0997],
            'Granada': [-3.6003, 37.1773],
            'Gyumri': [43.8597, 40.7504],
            'Hamburg': [9.9937, 53.5511],
            'Hannover': [9.7320, 52.3759],
            'Haugesund': [5.2681, 59.4138],
            'Helsinki': [24.9384, 60.1699],
            'Heraklion': [25.1803, 35.3387],
            'Hurghada': [33.8262, 27.2574],
            'Iasi': [27.6014, 47.1615],
            'Ibiza': [1.3712, 38.8728],
            'Istanbul': [28.9784, 41.0082],
            'Jeddah': [39.1637, 21.4858],
            'Karlsruhe/Baden-Baden': [8.4037, 49.0069],
            'Katowice': [19.0237, 50.2649],
            'Kaunas': [23.9036, 54.8985],
            'Kerkyra': [19.9156, 39.6243],
            'Kiev': [30.5234, 50.4501],
            'Kos': [27.2912, 36.8932],
            'Kosice': [21.2611, 48.7164],
            'Krakow': [19.9445, 50.0647],
            'Kutaisi': [42.6792, 42.2488],
            'Lamezia': [16.2423, 38.9054],
            'Larnaca': [33.6249, 34.9823],
            'Las Palmas': [-15.4138, 28.0997],
            'Leeds/Bradford': [-1.6606, 53.8659],
            'Leipzig': [12.3731, 51.3397],
            'Leipzig/Halle': [12.2363, 51.4324],
            'Lisbon': [-9.1393, 38.7223],
            'Liverpool': [-2.9779, 53.4084],
            'Ljubljana': [14.5058, 46.0569],
            'London': [-0.1276, 51.5074],
            'Lublin': [22.5684, 51.2465],
            'Luton': [-0.3682, 51.8747],
            'Lyon': [4.8357, 45.7640],
            'Madeira': [-16.9595, 32.6669],
            'Madinah': [39.6117, 24.5247],
            'Madrid': [-3.7038, 40.4168],
            'Malaga': [-4.4214, 36.6785],
            'Male': [73.5362, 4.1755],
            'Malmo': [13.0038, 55.6059],
            'Malta': [14.5414, 35.8997],
            'Manchester': [-2.2426, 53.4808],
            'Marrakech': [-8.0089, 31.6295],
            'Marsa Alam': [34.5836, 25.5574],
            'Marseille': [5.3698, 43.2965],
            'Memmingen': [10.2398, 47.9888],
            'Milan': [9.1900, 45.4642],
            'Mykonos': [25.3481, 37.4354],
            'Naples': [14.2681, 40.8518],
            'Nice': [7.2620, 43.7102],
            'Nis': [21.8958, 43.3209],
            'Nur-Sultan': [71.4704, 51.1801],
            'Nuremberg': [11.0767, 49.4521],
            'Ohrid': [20.8021, 41.1171],
            'Olbia': [9.5181, 40.8986],
            'Oslo': [10.7522, 59.9139],
            'Palermo': [13.3614, 38.1157],
            'Palma De Mallorca': [2.7386, 39.5516],
            'Paphos': [32.4856, 34.7181],
            'Paris': [2.3522, 48.8566],
            'Perugia': [12.3828, 43.1107],
            'Pescara': [14.2108, 42.4584],
            'Pisa': [10.4017, 43.7228],
            'Plovdiv': [24.7453, 42.1354],
            'Podgorica': [19.2636, 42.4304],
            'Poprad/Tatry': [20.2967, 49.0614],
            'Porto': [-8.6291, 41.1579],
            'Poznan': [16.9251, 52.4069],
            'Prague': [14.4378, 50.0755],
            'Pristina': [21.1655, 42.6629],
            'Radom': [21.1471, 51.4027],
            'Reykjavik': [-21.9426, 64.1466],
            'Rhodes': [28.0875, 36.4041],
            'Riga': [24.1052, 56.9496],
            'Rimini': [12.5674, 44.0678],
            'Riyadh': [46.6753, 24.7136],
            'Rome': [12.4964, 41.9028],
            'Rzeszow': [22.0190, 50.0412],
            'Salalah': [54.0914, 17.0387],
            'Salerno': [14.7681, 40.6824],
            'Salzburg': [13.0430, 47.8095],
            'Samarkand': [66.9597, 39.6270],
            'Santorini': [25.4615, 36.3932],
            'Sarajevo': [18.4131, 43.8476],
            'Satu Mare': [22.8578, 47.7925],
            'Sevilla': [-5.9845, 37.3891],
            'Sharm el-Sheikh': [34.3300, 27.9158],
            'Sibiu': [24.1512, 45.7983],
            'Skiathos': [23.5033, 39.1770],
            'Skopje': [21.4254, 41.9973],
            'Sofia': [23.3219, 42.6977],
            'Sohag': [31.6948, 26.5569],
            'Split': [16.4390, 43.5147],
            'Stavanger': [5.7331, 58.9700],
            'Stockholm': [18.0686, 59.3293],
            'Stuttgart': [9.1829, 48.7758],
            'Suceava': [26.2530, 47.6587],
            'Szczecin': [14.5528, 53.4285],
            'Tallinn': [24.7536, 59.4370],
            'Targu-Mures': [24.5525, 46.5403],
            'Tashkent': [69.2401, 41.2995],
            'Tel Aviv': [34.7818, 32.0853],
            'Tenerife': [-16.5725, 28.0473],
            'Thessaloniki': [22.9701, 40.6401],
            'Timisoara': [21.2270, 45.7489],
            'Tirana': [19.8187, 41.3275],
            'Trieste': [13.7758, 45.6495],
            'Tromso': [18.9560, 69.6496],
            'Trondheim': [10.3951, 63.4305],
            'Turin': [7.6869, 45.0703],
            'Turkistan': [68.2513, 43.2975],
            'Turku': [22.2666, 60.4518],
            'Tuzla': [18.6675, 44.5388],
            'Valencia': [-0.3763, 39.4699],
            'Varna': [27.9147, 43.2141],
            'Venice': [12.3155, 45.4408],
            'Verona': [10.9916, 45.4384],
            'Vienna': [16.3738, 48.2082],
            'Vilnius': [25.2797, 54.6872],
            'Warsaw': [21.0122, 52.2297],
            'Wroclaw': [17.0385, 51.1079],
            'Yerevan': [44.5152, 40.1792],
            'Zagreb': [15.9819, 45.8150],
            'Zakinthos Island': [20.8990, 37.7510],
            'Zakynthos': [20.8990, 37.7510],
            'Zaragoza': [-0.8773, 41.6488],
            'Zurich': [8.5417, 47.3769]
        };

        // Function to load dashboard data from JSON
        async function loadDashboardData() {
            try {
                const response = await fetch('./dashboard_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                throw error;
            }
        }

        // Function to update summary statistics
        function updateSummaryStats(summary) {
            document.getElementById('total-files').textContent = summary.totalDays;
            document.getElementById('avg-daily-flights').textContent = summary.avgDailyFlights;
            document.getElementById('date-range').textContent = summary.dateRange;
        }

        // Global variables for charts
        let weekdayChart = null;
        let routeMap = null;

        // Function to create the weekday chart using D3.js (responsive)
        function createWeekdayChart(weekdayStats) {
            const orderedDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const data = orderedDays.map(day => ({
                day: day,
                average: weekdayStats[day].average,
                stdDev: weekdayStats[day].stdDev,
                count: weekdayStats[day].count
            }));

            function draw() {
                // Clear any existing chart
                d3.select('#weekday-chart').selectAll('*').remove();

                // Create title
                d3.select('#weekday-chart')
                    .append('div')
                    .attr('class', 'chart-title')
                    .text('Average Number of Available Flights by Weekday');

                // Get container width for responsiveness
                const container = d3.select('#weekday-chart').node();
                const containerWidth = container.getBoundingClientRect().width;
                const margin = { top: 20, right: 30, bottom: 60, left: 70 };
                const width = containerWidth - margin.left - margin.right - 40; // 40px padding
                const height = 400 - margin.bottom - margin.top;

                if (width <= 0) return; // Don't draw if no space

                const svg = d3.select('#weekday-chart')
                    .append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom)
                    .style('display', 'block')
                    .style('margin', '0 auto');

                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                // Create scales
                const xScale = d3.scaleBand()
                    .domain(orderedDays)
                    .range([0, width])
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.average + d.stdDev)])
                    .range([height, 0]);

                // Create tooltip
                const tooltip = d3.select('#tooltip');

                // Create grid lines
                g.selectAll('.grid-line')
                    .data(yScale.ticks(8))
                    .enter()
                    .append('line')
                    .attr('class', 'grid-line')
                    .attr('x1', 0)
                    .attr('x2', width)
                    .attr('y1', d => yScale(d))
                    .attr('y2', d => yScale(d));

                // Create bars
                g.selectAll('.bar')
                    .data(data)
                    .enter()
                    .append('rect')
                    .attr('class', 'bar')
                    .attr('x', d => xScale(d.day))
                    .attr('y', d => yScale(d.average))
                    .attr('width', xScale.bandwidth())
                    .attr('height', d => height - yScale(d.average))
                    .style('fill', '#a71c49')
                    .style('opacity', 0.8)
                    .on('mouseover', function(event, d) {
                        d3.select(this).style('opacity', 1);
                        tooltip
                            .style('opacity', 1)
                            .html(`<strong>${d.day}</strong><br/>
                                   Average: ${Math.round(d.average)} flights<br/>
                                   Std Dev: ±${Math.round(d.stdDev)}<br/>
                                   Data points: ${d.count}`)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select(this).style('opacity', 0.8);
                        tooltip.style('opacity', 0);
                    });

                // Add error bars
                g.selectAll('.error-bar')
                    .data(data)
                    .enter()
                    .append('line')
                    .attr('class', 'error-bar')
                    .attr('x1', d => xScale(d.day) + xScale.bandwidth() / 2)
                    .attr('x2', d => xScale(d.day) + xScale.bandwidth() / 2)
                    .attr('y1', d => yScale(d.average - d.stdDev))
                    .attr('y2', d => yScale(d.average + d.stdDev))
                    .style('stroke', '#333')
                    .style('stroke-width', 1.5);

                // Add error bar caps
                const capWidth = Math.max(3, xScale.bandwidth() * 0.2);
                g.selectAll('.error-cap-top')
                    .data(data)
                    .enter()
                    .append('line')
                    .attr('class', 'error-cap-top')
                    .attr('x1', d => xScale(d.day) + xScale.bandwidth() / 2 - capWidth)
                    .attr('x2', d => xScale(d.day) + xScale.bandwidth() / 2 + capWidth)
                    .attr('y1', d => yScale(d.average + d.stdDev))
                    .attr('y2', d => yScale(d.average + d.stdDev))
                    .style('stroke', '#333')
                    .style('stroke-width', 1.5);

                g.selectAll('.error-cap-bottom')
                    .data(data)
                    .enter()
                    .append('line')
                    .attr('class', 'error-cap-bottom')
                    .attr('x1', d => xScale(d.day) + xScale.bandwidth() / 2 - capWidth)
                    .attr('x2', d => xScale(d.day) + xScale.bandwidth() / 2 + capWidth)
                    .attr('y1', d => yScale(d.average - d.stdDev))
                    .attr('y2', d => yScale(d.average - d.stdDev))
                    .style('stroke', '#333')
                    .style('stroke-width', 1.5);

                // Add value labels on bars
                g.selectAll('.bar-label')
                    .data(data)
                    .enter()
                    .append('text')
                    .attr('class', 'bar-label')
                    .attr('x', d => xScale(d.day) + xScale.bandwidth() / 2)
                    .attr('y', d => yScale(d.average) + 15)
                    .attr('text-anchor', 'middle')
                    .style('fill', 'white')
                    .style('font-size', Math.min(11, xScale.bandwidth() / 6) + 'px')
                    .style('font-weight', 'bold')
                    .text(d => Math.round(d.average));

                // Create axes
                const xAxis = d3.axisBottom(xScale);
                const yAxis = d3.axisLeft(yScale);

                g.append('g')
                    .attr('class', 'axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(xAxis)
                    .append('text')
                    .attr('x', width / 2)
                    .attr('y', 40)
                    .style('text-anchor', 'middle')
                    .style('fill', '#666')
                    .style('font-size', '12px')
                    .text('Day of Week');

                g.append('g')
                    .attr('class', 'axis')
                    .call(yAxis)
                    .append('text')
                    .attr('transform', 'rotate(-90)')
                    .attr('y', -50)
                    .attr('x', -height / 2)
                    .style('text-anchor', 'middle')
                    .style('fill', '#666')
                    .style('font-size', '12px')
                    .text('Average Number of Flights');
            }

            draw();
            weekdayChart = { draw, data: weekdayStats };
        }

        // Function to create route map using D3.js with real world map data
        function createRouteMap(data) {
            const topRoutes = data.topRoutes;
            console.log('Creating professional D3.js route map with real world data...');
            
            function draw() {
                // Clear any existing map
                d3.select('#route-map').selectAll('*').remove();

                // Create title
                d3.select('#route-map')
                    .append('div')
                    .attr('class', 'chart-title')
                    .html(`Wizz Air Complete Route Network<br/><span style="font-size: 12px; color: #666;">Showing all ${topRoutes.length} available routes</span>`);

                // Add map controls as overlay
                d3.select('#route-map')
                    .append('div')
                    .attr('class', 'map-controls')
                    .html(`
                        <button class="zoom-button" id="zoom-in" title="Zoom In">+</button>
                        <button class="zoom-button" id="zoom-out" title="Zoom Out">−</button>
                        <button class="zoom-button" id="reset-zoom" title="Reset View">⌂</button>
                    `);

                // Get container width for responsiveness
                const container = d3.select('#route-map').node();
                const containerWidth = container.getBoundingClientRect().width;
                const width = containerWidth - 40; // 40px padding
                const height = 500;

                if (width <= 0) return; // Don't draw if no space

                const svg = d3.select('#route-map')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .style('display', 'block')
                    .style('margin', '0 auto')
                    .style('border', '1px solid #ddd')
                    .style('border-radius', '8px')
                    .style('background-color', '#e6f3ff')
                    .style('shape-rendering', 'geometricPrecision')
                    .style('image-rendering', 'auto');

                // Create projection centered on Europe with better coverage
                const projection = d3.geoMercator()
                    .center([15, 54])
                    .scale(width / 8)
                    .translate([width / 2, height / 2]);

                const path = d3.geoPath().projection(projection);

                // Create zoom behavior with better event handling
                const zoom = d3.zoom()
                    .scaleExtent([0.5, 10])
                    .on('zoom', function(event) {
                        const { transform } = event;
                        
                        // Apply transform to zoomable elements
                        mapGroup.attr('transform', transform);
                        
                        // Keep city circles at consistent sizes
                        const scale = transform.k;
                        const adjustedScale = Math.pow(scale, 0.8);
                        
                        svg.selectAll('.city-circle')
                            .attr('r', 3 / adjustedScale)
                            .style('stroke-width', Math.max(0.5, 2 / adjustedScale));
                            
                        svg.selectAll('.route-line')
                            .style('stroke-width', d => Math.max(0.8, Math.log(d.count + 1) * 1.2) / scale);
                    });

                svg.call(zoom);

                // Create main group for map content
                const mapGroup = svg.append('g');

                // Load and draw real world map data
                d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(world => {
                    console.log('World map data loaded successfully');
                    
                    // Draw countries
                    mapGroup.selectAll('.country')
                        .data(topojson.feature(world, world.objects.countries).features)
                        .enter()
                        .append('path')
                        .attr('class', 'country')
                        .attr('d', path)
                        .style('fill', '#f8f9fa')
                        .style('stroke', '#ddd')
                        .style('stroke-width', 0.5);

                    // Draw country borders  
                    mapGroup.append('path')
                        .datum(topojson.mesh(world, world.objects.countries, (a, b) => a !== b))
                        .attr('class', 'country-borders')
                        .attr('d', path)
                        .style('fill', 'none')
                        .style('stroke', '#999')
                        .style('stroke-width', 0.5)
                        .style('stroke-linejoin', 'round');

                    // Now draw routes and cities on top of the map
                    drawRoutesAndCities();
                    
                }).catch(error => {
                    console.error('Failed to load world map data:', error);
                    // Fallback to simple background
                    mapGroup.append('rect')
                        .attr('width', width)
                        .attr('height', height)
                        .style('fill', '#f0f8ff')
                        .style('stroke', '#ccc');
                        
                    drawRoutesAndCities();
                });

                function drawRoutesAndCities() {
                    // Create tooltip
                    const tooltip = d3.select('#tooltip');

                    // Get total days for percentage calculation
                    const totalDays = data.metadata.totalDays;

                    // Process routes and cities
                    const citySet = new Set();
                    const routeLines = [];

                    topRoutes.forEach(route => {
                        const [city1, city2] = route.cities;
                        const coord1 = cityCoordinates[city1];
                        const coord2 = cityCoordinates[city2];
                        
                        if (coord1 && coord2) {
                            const proj1 = projection(coord1);
                            const proj2 = projection(coord2);
                            
                            citySet.add(city1);
                            citySet.add(city2);
                            routeLines.push({
                                source: proj1,
                                target: proj2,
                                cities: route.cities,
                                count: route.count,
                                dayCount: route.dayCount
                            });
                        }
                    });

                    // Draw route lines
                    mapGroup.selectAll('.route-line')
                        .data(routeLines)
                        .enter()
                        .append('line')
                        .attr('class', 'route-line')
                        .attr('x1', d => d.source[0])
                        .attr('y1', d => d.source[1])
                        .attr('x2', d => d.target[0])
                        .attr('y2', d => d.target[1])
                        .style('stroke', 'rgba(167, 28, 73, 0.1)')  // Ultra transparent by default
                        .style('stroke-width', d => Math.max(1.5, Math.log(d.count + 1) * 1.2))
                        .style('cursor', 'pointer')
                        .style('stroke-linecap', 'round')
                        .on('mouseover', function(event, d) {
                            d3.select(this)
                                .style('stroke', '#a71c49')
                                .style('stroke-opacity', 1)
                                .style('stroke-width', Math.max(3, Math.log(d.count + 1) * 2) / (svg.node().__zoom?.k || 1));
                            tooltip
                                .style('opacity', 1)
                                .html(`<strong>${d.cities[0]} ↔ ${d.cities[1]}</strong><br/>
                                       Available ${((d.dayCount / totalDays) * 100).toFixed(1)}% of days`)
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px');
                        })
                        .on('mouseout', function(event, d) {
                            d3.select(this)
                                .style('stroke', 'rgba(167, 28, 73, 0.1)')  // Return to ultra transparent state
                                .style('stroke-opacity', 1)
                                .style('stroke-width', Math.max(1.5, Math.log(d.count + 1) * 1.2) / (svg.node().__zoom?.k || 1));
                            tooltip.style('opacity', 0);
                        });

                    // Draw city circles
                    const cities = Array.from(citySet);
                    const cityData = cities.map(city => {
                        const routeCount = topRoutes.filter(route => route.cities.includes(city)).length;
                        return {
                            name: city,
                            position: projection(cityCoordinates[city]),
                            routeCount: routeCount
                        };
                    });

                    mapGroup.selectAll('.city-circle')
                        .data(cityData)
                        .enter()
                        .append('circle')
                        .attr('class', 'city-circle')
                        .attr('cx', d => d.position[0])
                        .attr('cy', d => d.position[1])
                        .attr('r', 3)
                        .style('fill', '#a71c49')
                        .style('stroke', 'white')
                        .style('stroke-width', 2)
                        .style('cursor', 'pointer')
                        .style('filter', 'drop-shadow(1px 1px 2px rgba(0,0,0,0.3))')
                        .on('mouseover', function(event, d) {
                            // Highlight hovered city
                            d3.select(this)
                                .style('stroke-width', 3)
                                .style('fill', '#8a1739');
                            
                            // Find connected routes for this city
                            const connectedRoutes = routeLines.filter(route => 
                                route.cities.includes(d.name)
                            );
                            
                            // Get all connected cities
                            const connectedCities = new Set();
                            connectedRoutes.forEach(route => {
                                route.cities.forEach(city => connectedCities.add(city));
                            });
                            
                            // Highlight connected routes
                            mapGroup.selectAll('.route-line')
                                .style('stroke', route => 
                                    route.cities.includes(d.name) ? '#a71c49' : 'rgba(167, 28, 73, 0.1)'
                                )
                                .style('stroke-opacity', route => 
                                    route.cities.includes(d.name) ? 1 : 1  // Keep opacity at 1, transparency is in the color
                                )
                                .style('stroke-width', route => {
                                    const baseWidth = Math.max(1.5, Math.log(route.count + 1) * 1.2);
                                    const scale = svg.node().__zoom?.k || 1;
                                    return route.cities.includes(d.name) ? (baseWidth * 1.5) / scale : baseWidth / scale;
                                });
                            
                            // Highlight connected cities and dim others
                            mapGroup.selectAll('.city-circle')
                                .style('fill', city => 
                                    connectedCities.has(city.name) ? '#a71c49' : 'rgba(167, 28, 73, 0.3)'
                                )
                                .style('stroke-opacity', city => 
                                    connectedCities.has(city.name) ? 1 : 0.5
                                );
                            
                            tooltip
                                .style('opacity', 1)
                                .html(`<strong>${d.name}</strong><br/>
                                       ${d.routeCount} routes`)
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px');
                        })
                        .on('mouseout', function() {
                            // Reset all styles to default
                            d3.select(this)
                                .style('stroke-width', 2)
                                .style('fill', '#a71c49');
                            
                            // Reset all route lines
                            mapGroup.selectAll('.route-line')
                                .style('stroke', 'rgba(167, 28, 73, 0.1)')  // Back to ultra transparent default
                                .style('stroke-opacity', 1)
                                .style('stroke-width', d => {
                                    const scale = svg.node().__zoom?.k || 1;
                                    return Math.max(1.5, Math.log(d.count + 1) * 1.2) / scale;
                                });
                            
                            // Reset all city circles
                            mapGroup.selectAll('.city-circle')
                                .style('fill', '#a71c49')
                                .style('stroke-opacity', 1);
                            
                            tooltip.style('opacity', 0);
                        });

                    console.log(`Professional route map created with ${routeLines.length} routes and ${cityData.length} cities`);
                }

                // Zoom controls with direct zoom manipulation
                d3.select('#zoom-in').on('click', function() {
                    const currentTransform = d3.zoomTransform(svg.node());
                    const newK = Math.min(currentTransform.k * 1.5, 10);
                    svg.call(zoom.transform, d3.zoomIdentity.translate(currentTransform.x, currentTransform.y).scale(newK));
                });

                d3.select('#zoom-out').on('click', function() {
                    const currentTransform = d3.zoomTransform(svg.node());
                    const newK = Math.max(currentTransform.k / 1.5, 0.5);
                    svg.call(zoom.transform, d3.zoomIdentity.translate(currentTransform.x, currentTransform.y).scale(newK));
                });

                d3.select('#reset-zoom').on('click', function() {
                    svg.call(zoom.transform, d3.zoomIdentity);
                });
            }

            draw();
            routeMap = { draw, data: topRoutes };
        }

        // Function to show error message
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').textContent = `Error: ${message}`;
        }

        // Function to update last updated timestamp
        function updateLastUpdated(timestamp) {
            const date = new Date(timestamp);
            document.getElementById('last-updated').textContent = 
                `Last updated: ${date.toLocaleString()}`;
        }

        // Main function to load and display dashboard
        async function loadDashboard() {
            try {
                const data = await loadDashboardData();
                
                // Update summary statistics
                updateSummaryStats(data.summary);
                
                // Create weekday chart
                document.getElementById('loading').style.display = 'none';
                document.getElementById('weekday-chart').style.display = 'block';
                createWeekdayChart(data.weekdayStats);
                
                // Create route map
                if (data.topRoutes && data.topRoutes.length > 0) {
                    document.getElementById('route-map').style.display = 'block';
                    createRouteMap(data);
                }
                
                // Update last updated timestamp
                updateLastUpdated(data.generated_at);
                
                console.log('Dashboard loaded successfully');
                console.log('Data summary:', data.metadata);
                
            } catch (error) {
                console.error('Dashboard loading error:', error);
                showError(error.message || 'Failed to load flight data. Please try again later.');
            }
        }

        // Function to handle window resize
        function handleResize() {
            // Debounce resize events to avoid excessive redrawing
            clearTimeout(window.resizeTimeout);
            window.resizeTimeout = setTimeout(() => {
                // Redraw charts if they exist
                if (weekdayChart && weekdayChart.draw) {
                    weekdayChart.draw();
                }
                if (routeMap && routeMap.draw) {
                    routeMap.draw();
                }
            }, 250); // 250ms debounce
        }

        // Load dashboard when page loads
        document.addEventListener('DOMContentLoaded', loadDashboard);
        
        // Add window resize listener for responsive charts
        window.addEventListener('resize', handleResize);
    </script>
</body>
</html>